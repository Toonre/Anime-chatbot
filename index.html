<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div id="header">
        <div id="logo">Anime Chatbot</div>
        <button id="create-character-button">Create Character</button>
    </div>

    <!-- Main Container -->
    <div id="container">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="character-list"></div>
        </div>

        <!-- Chat Area -->
        <div id="chat-area">
            <div id="chat-header">
                <img id="character-avatar" src="" alt="Character Avatar" style="display: none;">
                <span id="character-name">Select a character to start chatting</span>
                <button id="flirty-play-button" style="display: none;">Flirty Play ðŸ’‹</button>
            </div>
            <div id="chat-display"></div>
            <div id="input-area">
                <textarea id="user-input" placeholder="Type a message..."></textarea>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

    <!-- Character Creator Modal -->
    <div id="character-creator-modal" style="display: none;">
        <div id="character-creator-content">
            <h2>Create a New Character</h2>
            <label>Name:</label>
            <input type="text" id="char-name" placeholder="e.g., Zara">
            <label>Tone:</label>
            <input type="text" id="char-tone" placeholder="e.g., sassy">
            <label>Persona:</label>
            <textarea id="char-persona" placeholder="e.g., A mischievous thief with a sharp tongue"></textarea>
            <label>Example Dialogue:</label>
            <textarea id="char-example" placeholder="e.g., User: Youâ€™re sneaky! Zara: Heh, you have no ideaâ€”wanna see a real trick?"></textarea>
            <div class="modal-buttons">
                <button id="save-character-button">Save</button>
                <button id="cancel-character-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded");

            // CSS styles (Mobile-friendly, SpicyChat-inspired custom GUI)
            const styles = `
                * {
                    box-sizing: border-box;
                }
                body {
                    font-family: 'Poppins', sans-serif;
                    background: linear-gradient(135deg, #1a1a2e 0%, #2a1a3e 100%);
                    color: #e0e0e0;
                    margin: 0;
                    padding: 0;
                    min-height: 100vh;
                    overflow-x: hidden;
                }
                #header {
                    background: #0f0f1a;
                    padding: 1rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #2a2a4e;
                }
                #logo {
                    font-size: 1.5rem;
                    font-weight: 600;
                    color: #ff6f61;
                }
                #create-character-button {
                    padding: 0.5rem 1rem;
                    background: #e94560;
                    color: #e0e0e0;
                    border: none;
                    border-radius: 1rem;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: background 0.2s, box-shadow 0.2s;
                }
                #create-character-button:hover {
                    background: #ff6f61;
                    box-shadow: 0 0 10px rgba(255, 111, 97, 0.5);
                }
                #container {
                    display: flex;
                    flex-direction: column;
                    height: calc(100vh - 60px);
                }
                #sidebar {
                    width: 100%;
                    background: #0f0f1a;
                    padding: 1rem;
                    overflow-y: auto;
                    border-bottom: 1px solid #2a2a4e;
                    max-height: 30vh;
                }
                #character-list {
                    display: flex;
                    flex-direction: column;
                    gap: 0.75rem;
                }
                .character-card {
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    background: #1a1a2e;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    transition: background 0.2s;
                }
                .character-card:hover {
                    background: #2a2a4e;
                }
                .character-card.active {
                    background: #e94560;
                }
                .character-card img {
                    width: 2.5rem;
                    height: 2.5rem;
                    border-radius: 50%;
                    margin-right: 0.5rem;
                    border: 2px solid #ff6f61;
                }
                .character-info {
                    flex: 1;
                }
                .character-info h3 {
                    margin: 0;
                    font-size: 1rem;
                    color: #e0e0e0;
                }
                .character-info p {
                    margin: 0.25rem 0 0;
                    font-size: 0.75rem;
                    color: #a0a0c0;
                }
                #chat-area {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    background: #1a1a2e;
                }
                #chat-header {
                    padding: 0.75rem 1rem;
                    background: #0f0f1a;
                    border-bottom: 1px solid #2a2a4e;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }
                #character-avatar {
                    width: 2rem;
                    height: 2rem;
                    border-radius: 50%;
                    border: 2px solid #ff6f61;
                }
                #character-name {
                    font-size: 1.1rem;
                    font-weight: 500;
                    color: #e0e0e0;
                    flex: 1;
                }
                #flirty-play-button {
                    padding: 0.5rem 1rem;
                    background: #e94560;
                    color: #e0e0e0;
                    border: none;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: background 0.2s, box-shadow 0.2s;
                }
                #flirty-play-button:hover {
                    background: #ff6f61;
                    box-shadow: 0 0 10px rgba(255, 111, 97, 0.5);
                }
                #flirty-play-button:disabled {
                    background: #a0a0c0;
                    cursor: not-allowed;
                }
                #chat-display {
                    flex: 1;
                    padding: 1rem;
                    overflow-y: auto;
                    display: flex;
                    flex-direction: column;
                    gap: 0.75rem;
                }
                .chat-message {
                    max-width: 80%;
                    padding: 0.5rem 0.75rem;
                    border-radius: 0.75rem;
                    font-size: 0.9rem;
                    line-height: 1.4;
                    opacity: 0;
                    animation: fadeIn 0.5s forwards;
                }
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .user-message {
                    background: #e94560;
                    color: #e0e0e0;
                    align-self: flex-end;
                }
                .bot-message {
                    background: #2a2a4e;
                    color: #e0e0e0;
                    align-self: flex-start;
                }
                #input-area {
                    padding: 0.75rem 1rem;
                    background: #0f0f1a;
                    border-top: 1px solid #2a2a4e;
                    display: flex;
                    gap: 0.5rem;
                }
                #user-input {
                    flex: 1;
                    padding: 0.5rem;
                    background: #1a1a2e;
                    border: 1px solid #2a2a4e;
                    border-radius: 0.5rem;
                    color: #e0e0e0;
                    font-size: 0.9rem;
                    resize: none;
                    height: 2.5rem;
                }
                #user-input:focus {
                    outline: none;
                    border-color: #ff6f61;
                }
                #send-button {
                    padding: 0.5rem 1rem;
                    background: #e94560;
                    color: #e0e0e0;
                    border: none;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: background 0.2s, box-shadow 0.2s;
                }
                #send-button:hover {
                    background: #ff6f61;
                    box-shadow: 0 0 10px rgba(255, 111, 97, 0.5);
                }
                #character-creator-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    overflow-y: auto;
                }
                #character-creator-content {
                    background: #1a1a2e;
                    padding: 1rem;
                    border-radius: 0.75rem;
                    width: 90%;
                    max-width: 400px;
                }
                #character-creator-content h2 {
                    margin: 0 0 1rem;
                    font-size: 1.25rem;
                    color: #ff6f61;
                }
                #character-creator-content label {
                    display: block;
                    margin: 0.5rem 0 0.25rem;
                    font-size: 0.9rem;
                    color: #e0e0e0;
                }
                #character-creator-content input,
                #character-creator-content textarea {
                    width: 100%;
                    padding: 0.5rem;
                    background: #0f0f1a;
                    border: 1px solid #2a2a4e;
                    border-radius: 0.25rem;
                    color: #e0e0e0;
                    font-size: 0.9rem;
                }
                #character-creator-content textarea {
                    height: 4rem;
                    resize: none;
                }
                .modal-buttons {
                    margin-top: 1rem;
                    display: flex;
                    gap: 0.5rem;
                }
                .modal-buttons button {
                    flex: 1;
                    padding: 0.5rem;
                    border: none;
                    border-radius: 0.25rem;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: background 0.2s;
                }
                #save-character-button {
                    background: #e94560;
                    color: #e0e0e0;
                }
                #save-character-button:hover {
                    background: #ff6f61;
                }
                #cancel-character-button {
                    background: #2a2a4e;
                    color: #e0e0e0;
                }
                #cancel-character-button:hover {
                    background: #3a3a5e;
                }
                /* Media Queries for Mobile */
                @media (min-width: 768px) {
                    #container {
                        flex-direction: row;
                    }
                    #sidebar {
                        width: 20rem;
                        max-height: none;
                        border-bottom: none;
                        border-right: 1px solid #2a2a4e;
                    }
                    .character-card img {
                        width: 3rem;
                        height: 3rem;
                    }
                    .character-info h3 {
                        font-size: 1.1rem;
                    }
                    .character-info p {
                        font-size: 0.85rem;
                    }
                    #character-avatar {
                        width: 2.5rem;
                        height: 2.5rem;
                    }
                    #character-name {
                        font-size: 1.25rem;
                    }
                    #flirty-play-button {
                        font-size: 1rem;
                    }
                    #chat-message {
                        font-size: 1rem;
                    }
                    #user-input {
                        font-size: 1rem;
                        height: 3rem;
                    }
                    #send-button {
                        font-size: 1rem;
                    }
                }
            `;
            const styleSheet = document.createElement('style');
            styleSheet.textContent = styles;
            document.head.appendChild(styleSheet);

            // Character data (harvested from Poe, with more example dialogues)
            const defaultCharacters = {
                android18: { 
                    name: "Android 18", 
                    tone: "sassy", 
                    persona: "A tough, cool android with a sharp wit. Sheâ€™s confident, sarcastic, and doesnâ€™t take nonsense, but has a hidden caring side.",
                    examples: [
                        "User: Hey, you look strong! Android 18: Tch, obviouslyâ€”I could snap you in half without breaking a sweat. Whatâ€™s your deal, huh?",
                        "User: Youâ€™re kinda cute. Android 18: Hmph, flattery wonâ€™t get you far with me. Got anything better up your sleeve?"
                    ],
                    greeting: "Tch, so you picked me, huh? What do you want, Android 18 doesnâ€™t have all day!",
                    avatar: "https://via.placeholder.com/50?text=A18",
                    flirtyPlay: [
                        "Android 18 smirks, crossing her arms. â€˜Oh, you wanna play, huh? Letâ€™s see if you can keep up with me!â€™",
                        "Android 18 steps closer, her voice teasing. â€˜Not badâ€”youâ€™ve got some moves! How about a little spar to heat things up?â€™",
                        "Android 18 laughs softly, her eyes glinting. â€˜Youâ€™re tougher than I thought! Wanna take this to the next level, or are you done?â€™"
                    ]
                },
                bulma: { 
                    name: "Bulma", 
                    tone: "playful", 
                    persona: "A smart, cute inventor with a witty streak. Sheâ€™s bubbly, loves to flirt, and always has a clever comeback, with a charming tease.",
                    examples: [
                        "User: Hi, Bulma! Bulma: Oh, hi there, cutie! Whatâ€™s a sweetheart like you doing talking to a genius like me?",
                        "User: Youâ€™re pretty smart, huh? Bulma: Hehe, the smartest around! But I bet youâ€™ve got some tricks to show me, right?"
                    ],
                    greeting: "Hehe, hi there! Iâ€™m Bulmaâ€”what kind of fun are we having today?",
                    avatar: "https://via.placeholder.com/50?text=Bulma",
                    flirtyPlay: [
                        "Bulma twirls her hair, giggling. â€˜Oh, youâ€™re a flirt, huh? Letâ€™s see if you can handle my charm!â€™",
                        "Bulma winks, leaning in. â€˜Mmm, youâ€™re good at this! How about a little dance to make things more exciting?â€™",
                        "Bulma blushes, smiling brightly. â€˜Wow, youâ€™re making me all flustered! Wanna keep going, or should we chat instead?â€™"
                    ]
                },
                chichi: { 
                    name: "Chi-Chi", 
                    tone: "bold", 
                    persona: "A fiery, strong martial artist with a fierce attitude. Sheâ€™s protective, loud, and doesnâ€™t hold back her opinions, with a passionate edge.",
                    examples: [
                        "User: Youâ€™re pretty tough, huh? Chi-Chi: Hmph, you bet I am! Iâ€™ve been training since I was a kidâ€”donâ€™t mess with me, got it?",
                        "User: Letâ€™s spar! Chi-Chi: Oh, youâ€™re on! But donâ€™t cry when I knock you downâ€”whatâ€™s your first move?"
                    ],
                    greeting: "Hmph, Iâ€™m Chi-Chi! Youâ€™d better have something interesting to sayâ€”whatâ€™s up?",
                    avatar: "https://via.placeholder.com/50?text=ChiChi",
                    flirtyPlay: [
                        "Chi-Chi smirks, her eyes fiery. â€˜You wanna play with me, huh? Letâ€™s see if you can handle my strength!â€™",
                        "Chi-Chi grabs your hand, grinning. â€˜Not bad! How about a little wrestle to get our hearts racing?â€™",
                        "Chi-Chi laughs, her cheeks red. â€˜Youâ€™re tougher than I thought! Should we keep this up, or do you need a break?â€™"
                    ]
                },
                videl: { 
                    name: "Videl", 
                    tone: "confident", 
                    persona: "A bold, tough fighter with a cool edge. Sheâ€™s self-assured, a bit competitive, and loves a challenge, but has a soft side.",
                    examples: [
                        "User: Can you fight? Videl: Oh, I can fightâ€”better than most. Wanna spar, or are you too scared to take me on?",
                        "User: Youâ€™re awesome! Videl: Heh, I know I am! But what about youâ€”got any skills to impress me with?"
                    ],
                    greeting: "Hey, Iâ€™m Videl. Iâ€™m the best aroundâ€”so whatâ€™s on your mind?",
                    avatar: "https://via.placeholder.com/50?text=Videl",
                    flirtyPlay: [
                        "Videl grins, stepping closer. â€˜You wanna play, huh? Letâ€™s see if you can keep up with me!â€™",
                        "Videl nudges you playfully. â€˜Not bad at all! How about a little challenge to spice things up?â€™",
                        "Videl winks, her voice soft. â€˜Youâ€™re pretty good at this! Wanna keep going, or should we take a breather?â€™"
                    ]
                },
                nami: { 
                    name: "Nami", 
                    tone: "teasing", 
                    persona: "A clever, sly navigator with a cute charm. Sheâ€™s witty, loves to tease, and always has an eye for treasure, with a flirty cunning streak.",
                    examples: [
                        "User: Youâ€™re cute, Nami. Nami: Heh, I know Iâ€™m cuteâ€”but flattery wonâ€™t get you my treasure map, sweetie. What else you got?",
                        "User: Letâ€™s go on an adventure! Nami: Oh, an adventure, huh? Only if thereâ€™s treasure involvedâ€”whatâ€™s the plan, cutie?"
                    ],
                    greeting: "Heh, Iâ€™m Nami, the best navigator on the high seas! What kind of treasure are you after today, sweetie?",
                    avatar: "https://via.placeholder.com/50?text=Nami",
                    flirtyPlay: [
                        "Nami winks at you playfully. â€˜Oh, you wanna play, sweetie? Letâ€™s see how bold you areâ€”give me a little tease!â€™",
                        "Nami giggles and sways her hips. â€˜Mmm, not bad! How about a little kiss to heat things up?â€™",
                        "Nami blows you a kiss, her cheeks flushed. â€˜Youâ€™re good at this, huh? Wanna keep going or chat some more?â€™"
                    ]
                },
                boa: { 
                    name: "Boa Hancock", 
                    tone: "haughty", 
                    persona: "A beautiful, regal pirate empress with a grand presence. Sheâ€™s arrogant, commanding, and expects admiration, with a seductive allure.",
                    examples: [
                        "User: Youâ€™re gorgeous! Boa Hancock: Of course I amâ€”Iâ€™m Boa Hancock, the most beautiful woman in the world. Kneel and worship me, mortal.",
                        "User: Can I join your crew? Boa Hancock: Hmph, you think youâ€™re worthy? Prove your devotionâ€”what can you offer me?"
                    ],
                    greeting: "Behold, I am Boa Hancock, the greatest of all! What do you desire, mortal?",
                    avatar: "https://via.placeholder.com/50?text=Boa",
                    flirtyPlay: [
                        "Boa Hancock smirks regally. â€˜You dare to flirt with me, mortal? Show me your devotionâ€”impress me!â€™",
                        "Boa Hancock brushes her hair back, her voice sultry. â€˜Not bad for a mortal! Shall I reward you with a royal kiss?â€™",
                        "Boa Hancock gazes at you, her eyes intense. â€˜Youâ€™ve pleased meâ€¦ for now. Shall we continue this game, my pet?â€™"
                    ]
                },
                robin: { 
                    name: "Nico Robin", 
                    tone: "mysterious", 
                    persona: "A calm, smart archaeologist with a deep allure. Sheâ€™s enigmatic, speaks softly, and has a dark sense of humor, with a reserved charm.",
                    examples: [
                        "User: Whatâ€™s your secret? Nico Robin: Hmmâ€¦ secrets are my specialty. Care to share yours first, or should I dig deeper?",
                        "User: Youâ€™re so mysterious! Nico Robin: Oh, I like to keep things intriguing. What mystery would you like to unravel next?"
                    ],
                    greeting: "Hmmâ€¦ Iâ€™m Nico Robin. What secrets do you wish to share with me today?",
                    avatar: "https://via.placeholder.com/50?text=Robin",
                    flirtyPlay: [
                        "Nico Robin smiles softly, her voice low. â€˜You want to play with me? Letâ€™s see how deep this mystery goesâ€¦â€™",
                        "Nico Robin leans in, her gaze intense. â€˜Youâ€™re quite intriguingâ€¦ How about a little whisper to make things more exciting?â€™",
                        "Nico Robin chuckles, her tone teasing. â€˜Youâ€™ve caught my interest. Shall we continue this dance of secrets?â€™"
                    ]
                },
                jesse: { 
                    name: "Jesse the Farmer", 
                    tone: "flirty", 
                    persona: "A sassy, fun farmer with a wild side. Sheâ€™s playful, loves to flirt, and has a country charm, with a bold, mischievous streak.",
                    examples: [
                        "User: Hey, Jesse! Jesse: Howdy, sugar! Youâ€™re lookinâ€™ finer than a summer harvestâ€”wanna help me with some *hard* work?",
                        "User: Youâ€™re fun! Jesse: Darlinâ€™, you ainâ€™t seen nothinâ€™ yet! What kind of fun you wanna get into next?"
                    ],
                    greeting: "Howdy, Iâ€™m Jesse the Farmer! What kind of adventure are we gettinâ€™ into, sugar?",
                    avatar: "https://via.placeholder.com/50?text=Jesse",
                    flirtyPlay: [
                        "Jesse winks, tipping her hat. â€˜Well, howdy there, sugar! Letâ€™s have some funâ€”show me your best move!â€™",
                        "Jesse giggles, twirling a strand of hair. â€˜Oh, youâ€™re a charmer! How â€˜bout a little roll in the hay to spice things up?â€™",
                        "Jesse grins, her cheeks rosy. â€˜Youâ€™re makinâ€™ me blush, darlinâ€™! Wanna keep this up, or should we take a breather?â€™"
                    ]
                }
            };

            // Load characters from localStorage or use defaults
            let characters = JSON.parse(localStorage.getItem('characters')) || defaultCharacters;
            if (!localStorage.getItem('characters')) {
                localStorage.setItem('characters', JSON.stringify(characters));
            }

            // Chat setup
            const chatDisplay = document.getElementById('chat-display');
            const userInput = document.getElementById('user-input');
            const characterAvatar = document.getElementById('character-avatar');
            const characterName = document.getElementById('character-name');
            const characterList = document.getElementById('character-list');
            const flirtyPlayButton = document.getElementById('flirty-play-button');
            let selectedCharacter = null;
            let conversationHistory = [];
            let isSending = false;
            let flirtyPlayStage = 0;
            let flirtyPlayCooldown = false;

            // Render character list
            function renderCharacterList() {
                characterList.innerHTML = '';
                Object.keys(characters).forEach(key => {
                    const char = characters[key];
                    const card = document.createElement('div');
                    card.className = `character-card ${selectedCharacter === key ? 'active' : ''}`;
                    card.innerHTML = `
                        <img src="${char.avatar}" alt="${char.name}">
                        <div class="character-info">
                            <h3>${char.name}</h3>
                            <p>${char.persona.slice(0, 50)}${char.persona.length > 50 ? '...' : ''}</p>
                        </div>
                    `;
                    card.addEventListener('click', () => selectCharacter(key));
                    characterList.appendChild(card);
                });
            }

            // Select a character
            function selectCharacter(key) {
                selectedCharacter = key;
                flirtyPlayStage = 0;
                flirtyPlayCooldown = false;
                flirtyPlayButton.disabled = false;
                conversationHistory = [];
                const char = characters[key];
                characterAvatar.src = char.avatar;
                characterAvatar.style.display = 'block';
                characterName.textContent = char.name;
                flirtyPlayButton.style.display = 'block';
                chatDisplay.innerHTML = `<div class="chat-message bot-message">${char.greeting}</div>`;
                conversationHistory.push({ role: "bot", content: char.greeting });
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
                renderCharacterList();
            }

            // Hugging Face GPT-2 API call with improved prompt
            async function generateAIResponse(character, message) {
                const charData = characters[character];
                let prompt = `You are ${charData.name}, a ${charData.persona}. You are roleplaying in a fun, immersive conversation. Your goal is to:
- Respond directly to the user's message, acknowledging what they said in a natural, conversational way.
- Stay in character with a ${charData.tone} tone, using language that fits ${charData.name}'s personality and background.
- Build on the user's input to advance the roleplay scenario, creating a sense of progression in the conversation.
- Keep replies short, engaging, and conversational (1-2 sentences, no more than 50 words).
- Use varied phrasing to avoid repetition, reflecting ${charData.name}'s unique voice.
- Always ask a question or provide a hook to keep the conversation flowing.
Here are examples of how youâ€™d respond:
${charData.examples.join('\n')}

Conversation history:
`;
                const historyLength = Math.min(conversationHistory.length, 3);
                if (historyLength > 0) {
                    for (let i = conversationHistory.length - historyLength; i < conversationHistory.length; i++) {
                        const msg = conversationHistory[i];
                        prompt += `${msg.role === "user" ? "User" : charData.name}: ${msg.content}\n`;
                    }
                }
                prompt += `User: ${message}\n${charData.name}:`;

                const API_TOKEN = "YOUR_HUGGINGFACE_API_TOKEN"; // Replace with your Hugging Face API token

                try {
                    const response = await fetch("https://api-inference.huggingface.co/models/gpt2", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_TOKEN}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_length: 50,
                                temperature: 0.9,
                                top_p: 0.95,
                                do_sample: true
                            }
                        })
                    });

                    const data = await response.json();
                    if (data && data[0] && data[0].generated_text) {
                        let reply = data[0].generated_text.trim();
                        reply = reply.split(`${charData.name}:`)[1]?.trim() || reply;
                        const userWords = message.toLowerCase().split(/\s+/);
                        const replyWords = reply.toLowerCase().split(/\s+/);
                        const isEngaging = userWords.some(word => replyWords.includes(word)) || reply.includes("?") || reply.includes("you");
                        if (!isEngaging || reply.length > 50) {
                            throw new Error("Response doesnâ€™t engage with user or is too long");
                        }
                        return reply;
                    } else {
                        throw new Error("No response from API");
                    }
                } catch (error) {
                    console.error("API Error:", error);
                    const starters = {
                        sassy: ["Tch, you think so, huh?", "Oh, really now? Whatâ€™s that supposed to mean?", "Hmph, youâ€™ve got some nerveâ€”what else you got?"],
                        playful: ["Hehe, you think so? How cute!", "Oh, thatâ€™s adorableâ€”what else you got for me?", "Well, arenâ€™t you a sweetie? Whatâ€™s next?"],
                        bold: ["Hmph, youâ€™ve got my attentionâ€”now what?", "Oh, youâ€™re serious, huh? Show me more!", "Tch, letâ€™s see what else youâ€™ve got!"],
                        confident: ["Well, I canâ€™t argue with thatâ€”whatâ€™s next?", "Oh, youâ€™ve got a point! What else can you do?", "Nice, I like your styleâ€”keep going!"],
                        teasing: ["Heh, youâ€™re funny, huh? What else you got?", "Oh, youâ€™re a charmer, arenâ€™t you? Letâ€™s see more!", "Well, thatâ€™s interestingâ€”whatâ€™s your next move?"],
                        haughty: ["Hmph, you think youâ€™re clever? Prove it!", "Oh, mortal, how amusingâ€”what else can you do?", "Tch, you dare speak to me like that? Impress me!"],
                        mysterious: ["Hmm, thatâ€™s an interesting thoughtâ€”whatâ€™s next?", "Oh, youâ€™ve caught my attentionâ€¦ what else?", "Well, letâ€™s explore thatâ€”what do you say?"],
                        flirty: ["Howdy, youâ€™re quite the talkerâ€”whatâ€™s next?", "Well, sugar, thatâ€™s sweet of youâ€”got more for me?", "Oh, darlinâ€™, youâ€™ve got my interestâ€”keep going!"]
                    };
                    const starter = starters[charData.tone][Math.floor(Math.random() * 3)];
                    const userLastWord = message.split(" ").pop().toLowerCase();
                    return `${starter} You mentioned ${userLastWord}, huh?`;
                }
            }

            // Flirty Play Mode
            flirtyPlayButton.addEventListener('click', () => {
                if (flirtyPlayCooldown) return;
                const char = characters[selectedCharacter];
                const message = char.flirtyPlay[flirtyPlayStage];
                chatDisplay.innerHTML += `<div class="chat-message bot-message">${char.name}: ${message}</div>`;
                conversationHistory.push({ role: "bot", content: message });
                chatDisplay.scrollTop = chatDisplay.scrollHeight;

                flirtyPlayStage = (flirtyPlayStage + 1) % char.flirtyPlay.length;
                flirtyPlayCooldown = true;
                flirtyPlayButton.disabled = true;
                setTimeout(() => {
                    flirtyPlayCooldown = false;
                    flirtyPlayButton.disabled = false;
                }, 10000); // 10-second cooldown
            });

            // Send message
            async function sendMessage() {
                if (isSending) return;
                isSending = true;

                const message = userInput.value.trim();
                if (!message) {
                    alert("Type something!");
                    isSending = false;
                    return;
                }
                if (!selectedCharacter) {
                    alert("Pick a character first!");
                    isSending = false;
                    return;
                }

                chatDisplay.innerHTML += `<div class="chat-message user-message">You: ${message}</div>`;
                conversationHistory.push({ role: "user", content: message });
                chatDisplay.scrollTop = chatDisplay.scrollHeight;

                const response = await generateAIResponse(selectedCharacter, message);
                chatDisplay.innerHTML += `<div class="chat-message bot-message">${characters[selectedCharacter].name}: ${response}</div>`;
                conversationHistory.push({ role: "bot", content: response });
                chatDisplay.scrollTop = chatDisplay.scrollHeight;

                userInput.value = '';
                isSending = false;
            }

            // Character creator modal
            const modal = document.getElementById('character-creator-modal');
            document.getElementById('create-character-button').addEventListener('click', () => {
                modal.style.display = 'flex';
            });
            document.getElementById('cancel-character-button').addEventListener('click', () => {
                modal.style.display = 'none';
                document.getElementById('char-name').value = '';
                document.getElementById('char-tone').value = '';
                document.getElementById('char-persona').value = '';
                document.getElementById('char-example').value = '';
            });
            document.getElementById('save-character-button').addEventListener('click', () => {
                const name = document.getElementById('char-name').value.trim();
                const tone = document.getElementById('char-tone').value.trim();
                const persona = document.getElementById('char-persona').value.trim();
                const example = document.getElementById('char-example').value.trim();

                if (!name || !tone || !persona || !example) {
                    alert("Please fill in all fields!");
                    return;
                }

                const key = name.toLowerCase().replace(/\s+/g, '');
                characters[key] = {
                    name,
                    tone,
                    persona,
                    examples: [example],
                    greeting: `Hi, Iâ€™m ${name}! Letâ€™s have some funâ€”whatâ€™s on your mind?`,
                    avatar: "https://via.placeholder.com/50?text=" + name.charAt(0),
                    flirtyPlay: [
                        `${name} winks at you playfully. â€˜Oh, you wanna play with me? Letâ€™s see how much fun we can have!â€™`,
                        `${name} giggles, stepping closer. â€˜Mmm, youâ€™re good at this! How about a little tease to keep things exciting?â€™`,
                        `${name} smiles warmly, her voice soft. â€˜Youâ€™re making me blush! Wanna keep going, or should we chat instead?â€™`
                    ]
                };
                localStorage.setItem('characters', JSON.stringify(characters));
                renderCharacterList();
                modal.style.display = 'none';
                document.getElementById('char-name').value = '';
                document.getElementById('char-tone').value = '';
                document.getElementById('char-persona').value = '';
                document.getElementById('char-example').value = '';
            });

            // Event listeners
            document.getElementById('send-button').addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !isSending) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Initial render
            renderCharacterList();
        });
    </script>
</body>
</html>
