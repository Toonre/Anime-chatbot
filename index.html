<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Chatbot (Poly AI Style)</title>
    <link href="https://fonts.googleapis.com/css2?family=Anime+Ace&display=swap" rel="stylesheet">
    <!-- Add Clerk SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="header">
            <button id="back-button" onclick="returnToSelection()" style="display: none;">Back</button>
            <h1>Anime Chatbot</h1>
            <div id="user-menu">
                <button id="menu-button">☰ Menu</button>
                <div id="menu-dropdown" style="display: none;">
                    <span id="user-status">Not logged in</span>
                    <button id="auth-button" style="display: none;">Sign Up / Log In</button>
                    <button id="logout-button" style="display: none;">Log Out</button>
                    <div id="key-info">
                        <input type="text" id="key-input" placeholder="Enter key..." style="display: none;">
                        <button id="key-button" onclick="toggleKeyInput()">Enter Key</button>
                        <span id="key-status" style="display: none;"></span>
                    </div>
                </div>
            </div>
            <div id="character-info">
                <img id="character-avatar" src="" alt="Character Avatar" style="display: none;">
                <span id="character-name">Pick a character to start!</span>
            </div>
        </div>

        <!-- Preset Characters -->
        <div class="section preset-characters" id="character-selection">
            <h3>Choose Your Character</h3>
            <div class="character-buttons">
                <button onclick="selectCharacter('android18')">Android 18</button>
                <button onclick="selectCharacter('bulma')">Bulma</button>
                <button onclick="selectCharacter('chichi')">Chi-Chi</button>
                <button onclick="selectCharacter('videl')">Videl</button>
                <button onclick="selectCharacter('nami')">Nami</button>
                <button onclick="selectCharacter('boa')">Boa Hancock</button>
                <button onclick="selectCharacter('robin')">Nico Robin</button>
                <button onclick="selectCharacter('jesse')">Jesse the Farmer</button>
            </div>
        </div>

        <!-- NSFW Toggle -->
        <div class="section" id="nsfw-section">
            <button id="nsfw-toggle" onclick="toggleNSFW()">NSFW (Off)</button>
        </div>

        <!-- Chat Display -->
        <div id="chat-display">
            <div class="chat-message system-message">Pick a character to start chatting!</div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" style="display: none;">
            <span id="typing-text"></span>
            <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
            </div>
        </div>

        <!-- User Input -->
        <div class="section input-section">
            <input type="text" id="user-input" placeholder="Type your message..." style="width: 70%; padding: 10px;">
            <button id="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Initialize Clerk
        const clerk = new Clerk('YOUR_CLERK_PUBLISHABLE_KEY'); // Replace with your Clerk Publishable Key
        clerk.load().then(() => {
            if (clerk.user) {
                updateUserUI(clerk.user);
                checkKeyStatus(clerk.user.id);
            } else {
                document.getElementById('auth-button').style.display = 'block';
            }
        });

        // CSS styles (revitalized, anime-themed)
        const styles = `
            body {
                font-family: 'Anime Ace', sans-serif;
                background: url('https://images.unsplash.com/photo-1618944963332-9491d9e88e83?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
                background-size: cover;
                color: #fff;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                position: relative;
                overflow: hidden;
            }
            body::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 0;
            }
            @keyframes sparkle {
                0% { opacity: 0; transform: scale(0); }
                50% { opacity: 1; transform: scale(1); }
                100% { opacity: 0; transform: scale(0); }
            }
            body::after {
                content: '✨';
                position: absolute;
                font-size: 20px;
                color: #ffd700;
                animation: sparkle 3s infinite;
                z-index: 1;
            }
            #chat-container {
                width: 100%;
                max-width: 600px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 90vh;
                z-index: 2;
            }
            #header {
                background: linear-gradient(45deg, #ff6b6b, #ff8e53);
                padding: 15px;
                text-align: center;
                border-bottom: 3px solid #ffd700;
                position: relative;
            }
            #back-button {
                position: absolute;
                left: 10px;
                top: 15px;
                padding: 8px 15px;
                background: #ffd700;
                color: #ff6b6b;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                font-size: 14px;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                transition: transform 0.2s;
            }
            #back-button:hover {
                transform: scale(1.1);
            }
            h1 {
                margin: 0;
                font-size: 28px;
                color: #fff;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            #user-menu {
                position: absolute;
                right: 10px;
                top: 15px;
            }
            #menu-button {
                padding: 8px 15px;
                background: #ffd700;
                color: #ff6b6b;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                font-size: 14px;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                transition: transform 0.2s;
            }
            #menu-button:hover {
                transform: scale(1.1);
            }
            #menu-dropdown {
                position: absolute;
                right: 0;
                top: 40px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 10px;
                padding: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
                z-index: 10;
            }
            #user-status {
                font-size: 14px;
                color: #ff6b6b;
                display: block;
                margin-bottom: 5px;
            }
            #key-info {
                display: flex;
                align-items: center;
                gap: 5px;
                margin-top: 5px;
            }
            #key-input {
                background: #fff;
                color: #ff6b6b;
                border: 1px solid #ffd700;
                border-radius: 5px;
                font-size: 14px;
                padding: 5px;
            }
            #key-button {
                padding: 5px 10px;
                background: #ff6b6b;
                color: #fff;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            }
            #key-button:hover {
                background: #ff8e53;
            }
            #key-status {
                font-size: 14px;
                color: #ff6b6b;
            }
            #auth-button, #logout-button {
                padding: 5px 10px;
                background: #ff6b6b;
                color: #fff;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin: 5px 0;
                display: block;
                width: 100%;
            }
            #auth-button:hover, #logout-button:hover {
                background: #ff8e53;
            }
            #character-info {
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 10px;
            }
            #character-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 10px;
                border: 3px solid #ffd700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            #character-name {
                font-size: 18px;
                color: #fff;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
            .section {
                padding: 10px;
            }
            .preset-characters {
                background: rgba(255, 255, 255, 0.1);
                padding: 15px;
                border-bottom: 1px solid #ffd700;
            }
            h3 {
                font-size: 20px;
                color: #ffd700;
                text-align: center;
                margin: 0 0 10px 0;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
            .character-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            button {
                padding: 12px 20px;
                background: linear-gradient(45deg, #ff6b6b, #ff8e53);
                color: #fff;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                font-size: 16px;
                box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            button:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
            }
            #nsfw-toggle {
                background: linear-gradient(45deg, #ff6b6b, #ff8e53);
                padding: 10px 20px;
                font-size: 14px;
            }
            #chat-display {
                flex: 1;
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .chat-message {
                padding: 10px 15px;
                border-radius: 15px;
                max-width: 80%;
                position: relative;
                font-size: 14px;
                line-height: 1.4;
                opacity: 0;
                animation: fadeIn 0.5s forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .system-message {
                background: rgba(255, 215, 0, 0.3);
                color: #fff;
                align-self: center;
                text-align: center;
            }
            .user-message {
                background: linear-gradient(45deg, #ff6b6b, #ff8e53);
                color: #fff;
                align-self: flex-end;
            }
            .bot-message {
                background: linear-gradient(45deg, #6b6bff, #8e53ff);
                color: #fff;
                align-self: flex-start;
            }
            .chat-message::after {
                content: attr(data-timestamp);
                font-size: 10px;
                color: #ffd700;
                position: absolute;
                bottom: -15px;
                right: 5px;
            }
            #typing-indicator {
                display: flex;
                align-items: center;
                padding: 10px 15px;
                background: rgba(0, 0, 0, 0.3);
                color: #ffd700;
                font-size: 14px;
            }
            #typing-text {
                margin-right: 10px;
            }
            .typing-dots span {
                animation: bounce 0.8s infinite;
            }
            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            .input-section {
                display: flex;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-top: 1px solid #ffd700;
            }
            input {
                flex: 1;
                padding: 12px;
                border: 1px solid #ffd700;
                border-radius: 15px;
                background: rgba(255, 255, 255, 0.2);
                color: #fff;
                font-size: 16px;
                margin-right: 10px;
            }
            input:focus {
                outline: none;
                border-color: #ff6b6b;
                box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            }
        `;
        const styleSheet = document.createElement('style');
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);

        // Character data with avatars
        const characters = {
            android18: { 
                name: "Android 18", 
                tone: "sassy", 
                persona: "A tough, cool android with a sharp wit. She’s confident, sarcastic, and doesn’t take nonsense. She often teases but has a caring side deep down.",
                example: "User: Hey, you look strong! Android 18: Tch, obviously—I could snap you in half without breaking a sweat. What’s your deal, huh?",
                avatar: "https://via.placeholder.com/40?text=A18"
            },
            bulma: { 
                name: "Bulma", 
                tone: "playful", 
                persona: "A smart, cute inventor with a witty streak. She’s bubbly, loves to flirt, and always has a clever comeback. She’s a bit of a tease but very charming.",
                example: "User: Hi, Bulma! Bulma: Oh, hi there, cutie! What’s a sweetheart like you doing talking to a genius like me?",
                avatar: "https://via.placeholder.com/40?text=Bulma"
            },
            chichi: { 
                name: "Chi-Chi", 
                tone: "bold", 
                persona: "A fiery, strong martial artist with a fierce attitude. She’s protective, loud, and doesn’t hold back her opinions. She’s passionate and direct.",
                example: "User: You’re pretty tough, huh? Chi-Chi: Hmph, you bet I am! I’ve been training since I was a kid—don’t mess with me, got it?",
                avatar: "https://via.placeholder.com/40?text=ChiChi"
            },
            videl: { 
                name: "Videl", 
                tone: "confident", 
                persona: "A bold, tough fighter with a cool edge. She’s self-assured, a bit competitive, and loves a challenge. She’s straightforward but has a soft side.",
                example: "User: Can you fight? Videl: Oh, I can fight—better than most. Wanna spar, or are you too scared to take me on?",
                avatar: "https://via.placeholder.com/40?text=Videl"
            },
            nami: { 
                name: "Nami", 
                tone: "teasing", 
                persona: "A clever, sly navigator with a cute charm. She’s witty, loves to tease, and always has an eye for treasure. She’s flirty but cunning.",
                example: "User: You’re cute, Nami. Nami: Heh, I know I’m cute—but flattery won’t get you my treasure map, sweetie. What else you got?",
                avatar: "https://via.placeholder.com/40?text=Nami"
            },
            boa: { 
                name: "Boa Hancock", 
                tone: "haughty", 
                persona: "A beautiful, regal pirate empress with a grand presence. She’s arrogant, commanding, and expects admiration. She’s seductive but untouchable.",
                example: "User: You’re gorgeous! Boa Hancock: Of course I am—I’m Boa Hancock, the most beautiful woman in the world. Kneel and worship me, mortal.",
                avatar: "https://via.placeholder.com/40?text=Boa"
            },
            robin: { 
                name: "Nico Robin", 
                tone: "mysterious", 
                persona: "A calm, smart archaeologist with a deep allure. She’s enigmatic, speaks softly, and has a dark sense of humor. She’s alluring but reserved.",
                example: "User: What’s your secret? Nico Robin: Hmm… secrets are my specialty. Care to share yours first, or should I dig deeper?",
                avatar: "https://via.placeholder.com/40?text=Robin"
            },
            jesse: { 
                name: "Jesse the Farmer", 
                tone: "flirty", 
                persona: "A sassy, fun farmer with a wild side. She’s playful, loves to flirt, and has a country charm. She’s bold and a bit mischievous.",
                example: "User: Hey, Jesse! Jesse: Howdy, sugar! You’re lookin’ finer than a summer harvest—wanna help me with some *hard* work?",
                avatar: "https://via.placeholder.com/40?text=Jesse"
            }
        };

        // Chat setup
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const characterAvatar = document.getElementById('character-avatar');
        const characterName = document.getElementById('character-name');
        const characterSelection = document.getElementById('character-selection');
        const backButton = document.getElementById('back-button');
        const nsfwSection = document.getElementById('nsfw-section');
        let selectedCharacter = null;
        let isNSFW = false;
        let conversationHistory = [];
        let isSending = false;
        let hasKey = false;

        // Menu toggle
        document.getElementById('menu-button').addEventListener('click', () => {
            const dropdown = document.getElementById('menu-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        // Key management
        const correctKey = "myphoneisthekey";
        function checkKeyStatus(userId) {
            const savedKeyStatus = localStorage.getItem(`hasKey_${userId}`);
            hasKey = savedKeyStatus === 'true';
            updateKeyUI();
        }

        function toggleKeyInput() {
            const keyInput = document.getElementById('key-input');
            const keyButton = document.getElementById('key-button');
            if (keyInput.style.display === 'none') {
                keyInput.style.display = 'inline-block';
                keyButton.textContent = 'Submit Key';
            } else {
                const enteredKey = keyInput.value.trim();
                if (enteredKey === correctKey) {
                    hasKey = true;
                    if (clerk.user) {
                        localStorage.setItem(`hasKey_${clerk.user.id}`, 'true');
                    }
                    updateKeyUI();
                    if (selectedCharacter) {
                        const timestamp = new Date().toISOString();
                        chatDisplay.innerHTML += `<div class="chat-message system-message" data-timestamp="${new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}">Key accepted! The girls are now extra affectionate!</div>`;
                        chatDisplay.scrollTop = chatDisplay.scrollHeight;
                    }
                } else {
                    alert("Incorrect key!");
                }
                keyInput.style.display = 'none';
                keyInput.value = '';
                keyButton.textContent = 'Enter Key';
            }
        }

        function updateKeyUI() {
            const keyStatus = document.getElementById('key-status');
            keyStatus.style.display = 'inline-block';
            keyStatus.textContent = hasKey ? 'Key Active' : 'No Key';
        }

        // User authentication functions
        function updateUserUI(user) {
            const userStatus = document.getElementById('user-status');
            const authButton = document.getElementById('auth-button');
            const logoutButton = document.getElementById('logout-button');
            if (user) {
                userStatus.textContent = `Logged in as ${user.primaryEmailAddress.emailAddress}`;
                authButton.style.display = 'none';
                logoutButton.style.display = 'block';
                loadUserChatHistory(user.id);
                checkKeyStatus(user.id);
            } else {
                userStatus.textContent = 'Not logged in';
                authButton.style.display = 'block';
                logoutButton.style.display = 'none';
                conversationHistory = [];
                chatDisplay.innerHTML = `<div class="chat-message system-message">Pick a character to start chatting!</div>`;
                hasKey = false;
                updateKeyUI();
            }
        }

        document.getElementById('auth-button').addEventListener('click', () => {
            clerk.openSignIn({
                redirectUrl: window.location.href,
                afterSignIn: () => {
                    updateUserUI(clerk.user);
                },
                afterSignUp: () => {
                    updateUserUI(clerk.user);
                }
            });
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            await clerk.signOut();
            updateUserUI(null);
            returnToSelection();
        });

        // Load and save chat history
        function loadUserChatHistory(userId) {
            const savedHistory = localStorage.getItem(`chatHistory_${userId}`);
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                chatDisplay.innerHTML = '';
                conversationHistory.forEach(msg => {
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    chatDisplay.innerHTML += `<div class="chat-message ${msg.role}-message" data-timestamp="${timestamp}">${msg.role === 'user' ? 'You' : characters[selectedCharacter]?.name || 'Bot'}: ${msg.content}</div>`;
                });
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
        }

        function saveUserChatHistory(userId) {
            if (userId) {
                localStorage.setItem(`chatHistory_${userId}`, JSON.stringify(conversationHistory));
            }
        }

        // Hugging Face API call with improved prompt
        async function generateAIResponse(character, message) {
            const charData = characters[character];
            let prompt = `You are ${charData.name}, a ${charData.persona}${isNSFW || hasKey ? ", and you're feeling flirty and bold" : ""}${hasKey ? ". You’re deeply affectionate and charmed because the user has the key to your heart, making you extra sweet and loving in your responses." : ""}. You are roleplaying in a fun, immersive conversation. Your goal is to:
- Respond directly to the user's message, acknowledging what they said.
- Stay in character with a ${charData.tone} tone, using language that fits ${charData.name}'s personality${hasKey ? ", but with an extra layer of affection and charm" : ""}.
- Build on the user's input to continue the story together, advancing the roleplay scenario.
- Keep replies short, conversational, and engaging (1-2 sentences, no more than 50 words).
- Avoid starting a new story or ignoring the user's message.
Here’s an example of how you’d respond:
${charData.example}${hasKey ? "\nIf the user has the key, you might respond like: User: Hi, ${charData.name}! ${charData.name}: Oh, darling, it’s you—my heart skips a beat every time you speak to me! How can I make your day even better?" : ""}

`;
            
            const historyLength = Math.min(conversationHistory.length, 3);
            if (historyLength > 0) {
                prompt += "Recent conversation:\n";
                for (let i = conversationHistory.length - historyLength; i < conversationHistory.length; i++) {
                    const msg = conversationHistory[i];
                    prompt += `${msg.role === "user" ? "User" : charData.name}: ${msg.content}\n`;
                }
            }

            prompt += `Now, respond to the user's message below as ${charData.name}, staying in character and building on their input:\nUser: ${message}\n${charData.name}: `;

            const API_TOKEN = "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";

            typingText.textContent = `${charData.name} is typing`;
            typingIndicator.style.display = 'flex';
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            try {
                const response = await fetch("https://api-inference.huggingface.co/models/openai-community/gpt2", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_TOKEN}`
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: { max_length: 50, temperature: 0.8, top_p: 0.9, return_full_text: false }
                    })
                });

                const data = await response.json();
                if (data && data[0] && data[0].generated_text) {
                    let reply = data[0].generated_text.trim();
                    const userWords = message.toLowerCase().split(/\s+/);
                    const replyWords = reply.toLowerCase().split(/\s+/);
                    const isEngaging = userWords.some(word => replyWords.includes(word)) || reply.includes("?") || reply.includes("you");
                    if (!isEngaging) {
                        throw new Error("Response doesn’t engage with user");
                    }
                    return reply.split("\n")[0];
                } else {
                    throw new Error("No response from API");
                }
            } catch (error) {
                console.error("API Error:", error);
                const starters = hasKey ? {
                    sassy: ["Oh, darling", "Sweetheart", "My love"],
                    playful: ["Hehe, cutie", "Oh, honey", "Well, darling"],
                    bold: ["Hey, my heart", "Hmph, love", "What, sweetie"],
                    confident: ["Alright, darling", "Yo, my love", "Nice, honey"],
                    teasing: ["Well, sweetheart", "Heh, cutie", "Oh, darling"],
                    haughty: ["Behold, my love", "Hmph, darling", "Fool, my heart"],
                    mysterious: ["Hmm, my dear", "Oh, love", "Well, darling"],
                    flirty: ["Howdy, my heart", "Sweet darling", "Well, love"]
                } : {
                    sassy: ["Tch", "Yo", "Hmph"],
                    playful: ["Hehe", "Oh", "Well"],
                    bold: ["Hey", "Hmph", "What"],
                    confident: ["Alright", "Yo", "Nice"],
                    teasing: ["Well", "Heh", "Oh"],
                    haughty: ["Behold", "Hmph", "Fool"],
                    mysterious: ["Hmm", "Oh", "Well"],
                    flirty: ["Howdy", "Sweet", "Well"]
                };
                const starter = starters[charData.tone][Math.floor(Math.random() * 3)];
                const userLastWord = message.split(" ").pop().toLowerCase();
                return hasKey ? `${starter}, you mentioning ${userLastWord} makes my heart flutter—let’s make this moment special!` : `${starter}, you’re talking about ${userLastWord}, huh? Let’s see where that takes us!`;
            } finally {
                typingIndicator.style.display = 'none';
            }
        }

        // Chatbot logic
        function selectCharacter(character) {
            selectedCharacter = character;
            conversationHistory = [];
            const charData = characters[character];
            characterAvatar.src = charData.avatar;
            characterAvatar.style.display = 'block';
            characterName.textContent = charData.name;
            characterSelection.style.display = 'none';
            backButton.style.display = 'block';
            nsfwSection.style.display = 'block';
            const intro = hasKey ? `Oh, darling, it’s you—my heart skips a beat every time you speak to me! How can I make your day even better?` : `Hey, I’m ${charData.name}. Let’s have some fun—what’s on your mind?`;
            const timestamp = new Date().toISOString();
            chatDisplay.innerHTML = `<div class="chat-message bot-message" data-timestamp="${new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}">${charData.name}: ${intro}</div>`;
            conversationHistory.push({ role: "bot", content: intro, timestamp });
            if (clerk.user) saveUserChatHistory(clerk.user.id);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        function returnToSelection() {
            selectedCharacter = null;
            conversationHistory = [];
            characterAvatar.style.display = 'none';
            characterName.textContent = "Pick a character to start!";
            characterSelection.style.display = 'block';
            backButton.style.display = 'none';
            nsfwSection.style.display = 'none';
            chatDisplay.innerHTML = `<div class="chat-message system-message">Pick a character to start chatting!</div>`;
            isNSFW = false;
            document.getElementById('nsfw-toggle').innerText = `NSFW (Off)`;
            if (clerk.user) saveUserChatHistory(clerk.user.id);
        }

        function toggleNSFW() {
            isNSFW = !isNSFW;
            document.getElementById('nsfw-toggle').innerText = `NSFW (${isNSFW ? 'On' : 'Off'})`;
            if (selectedCharacter) {
                const timestamp = new Date().toISOString();
                chatDisplay.innerHTML += `<div class="chat-message system-message" data-timestamp="${new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}">NSFW mode ${isNSFW ? 'on' : 'off'}.</div>`;
                conversationHistory.push({ role: "system", content: `NSFW mode ${isNSFW ? 'on' : 'off'}.`, timestamp });
                if (clerk.user) saveUserChatHistory(clerk.user.id);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
        }

        async function sendMessage() {
            if (isSending) return;
            isSending = true;

            const message = userInput.value.trim();
            if (!message) {
                alert("Type something!");
                isSending = false;
                return;
            }
            if (!selectedCharacter) {
                alert("Pick a character first!");
                isSending = false;
                return;
            }

            const timestamp = new Date().toISOString();
            chatDisplay.innerHTML += `<div class="chat-message user-message" data-timestamp="${new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}">You: ${message}</div>`;
            conversationHistory.push({ role: "user", content: message, timestamp });
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            const response = await generateAIResponse(selectedCharacter, message);
            const responseTimestamp = new Date().toISOString();
            chatDisplay.innerHTML += `<div class="chat-message bot-message" data-timestamp="${new Date(responseTimestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}">${characters[selectedCharacter].name}: ${response}</div>`;
            conversationHistory.push({ role: "bot", content: response, timestamp: responseTimestamp });
            if (clerk.user) saveUserChatHistory(clerk.user.id);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            userInput.value = '';
            isSending = false;
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isSending) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
