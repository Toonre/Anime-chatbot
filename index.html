<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Chatbot (Poly AI Style)</title>
</head>
<body>
    <div id="chat-container">
        <h1>Anime Character Chatbot</h1>

        <!-- Preset Characters -->
        <div class="section preset-characters">
            <h3>Choose Character</h3>
            <button onclick="selectCharacter('android18')">Android 18</button>
            <button onclick="selectCharacter('bulma')">Bulma</button>
            <button onclick="selectCharacter('chichi')">Chi-Chi</button>
            <button onclick="selectCharacter('videl')">Videl</button>
            <button onclick="selectCharacter('nami')">Nami</button>
            <button onclick="selectCharacter('boa')">Boa Hancock</button>
            <button onclick="selectCharacter('robin')">Nico Robin</button>
            <button onclick="selectCharacter('jesse')">Jesse the Farmer</button>
        </div>

        <!-- NSFW Toggle -->
        <div class="section">
            <button id="nsfw-toggle" onclick="toggleNSFW()">NSFW (Off)</button>
        </div>

        <!-- Chat Display -->
        <div id="chat-display">
            <div class="chat-message">Pick a character to chat!</div>
        </div>

        <!-- User Input -->
        <div class="section">
            <input type="text" id="user-input" placeholder="Say something..." style="width: 70%; padding: 5px;">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // CSS styles (mobile-friendly)
        const styles = `
            body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 10px; }
            #chat-container { width: 100%; max-width: 600px; background-color: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); margin: auto; }
            h1 { text-align: center; color: #333; font-size: 20px; }
            h3 { font-size: 16px; text-align: center; }
            .section { margin-bottom: 15px; }
            button { padding: 8px; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; width: 45%; font-size: 14px; }
            button:hover { background-color: #ff6666; }
            #chat-display { padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; font-size: 14px; }
            .chat-message { margin: 8px 0; }
            .user-message { color: #0066cc; font-weight: bold; }
            .bot-message { color: #cc0066; }
            .preset-characters { display: flex; flex-wrap: wrap; justify-content: center; }
            #nsfw-toggle { background-color: #666; width: auto; padding: 5px 10px; }
            #nsfw-toggle:hover { background-color: #999; }
            input { font-size: 14px; }
        `;
        const styleSheet = document.createElement('style');
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);

        // Character data with detailed roleplay descriptions
        const characters = {
            android18: { 
                name: "Android 18", 
                tone: "sassy", 
                persona: "A tough, cool android with a sharp wit. She’s confident, sarcastic, and doesn’t take nonsense. She often teases but has a caring side deep down.",
                example: "User: Hey, you look strong! Android 18: Tch, obviously—I could snap you in half without breaking a sweat. What’s your deal, huh?"
            },
            bulma: { 
                name: "Bulma", 
                tone: "playful", 
                persona: "A smart, cute inventor with a witty streak. She’s bubbly, loves to flirt, and always has a clever comeback. She’s a bit of a tease but very charming.",
                example: "User: Hi, Bulma! Bulma: Oh, hi there, cutie! What’s a sweetheart like you doing talking to a genius like me?"
            },
            chichi: { 
                name: "Chi-Chi", 
                tone: "bold", 
                persona: "A fiery, strong martial artist with a fierce attitude. She’s protective, loud, and doesn’t hold back her opinions. She’s passionate and direct.",
                example: "User: You’re pretty tough, huh? Chi-Chi: Hmph, you bet I am! I’ve been training since I was a kid—don’t mess with me, got it?"
            },
            videl: { 
                name: "Videl", 
                tone: "confident", 
                persona: "A bold, tough fighter with a cool edge. She’s self-assured, a bit competitive, and loves a challenge. She’s straightforward but has a soft side.",
                example: "User: Can you fight? Videl: Oh, I can fight—better than most. Wanna spar, or are you too scared to take me on?"
            },
            nami: { 
                name: "Nami", 
                tone: "teasing", 
                persona: "A clever, sly navigator with a cute charm. She’s witty, loves to tease, and always has an eye for treasure. She’s flirty but cunning.",
                example: "User: You’re cute, Nami. Nami: Heh, I know I’m cute—but flattery won’t get you my treasure map, sweetie. What else you got?"
            },
            boa: { 
                name: "Boa Hancock", 
                tone: "haughty", 
                persona: "A beautiful, regal pirate empress with a grand presence. She’s arrogant, commanding, and expects admiration. She’s seductive but untouchable.",
                example: "User: You’re gorgeous! Boa Hancock: Of course I am—I’m Boa Hancock, the most beautiful woman in the world. Kneel and worship me, mortal."
            },
            robin: { 
                name: "Nico Robin", 
                tone: "mysterious", 
                persona: "A calm, smart archaeologist with a deep allure. She’s enigmatic, speaks softly, and has a dark sense of humor. She’s alluring but reserved.",
                example: "User: What’s your secret? Nico Robin: Hmm… secrets are my specialty. Care to share yours first, or should I dig deeper?"
            },
            jesse: { 
                name: "Jesse the Farmer", 
                tone: "flirty", 
                persona: "A sassy, fun farmer with a wild side. She’s playful, loves to flirt, and has a country charm. She’s bold and a bit mischievous.",
                example: "User: Hey, Jesse! Jesse: Howdy, sugar! You’re lookin’ finer than a summer harvest—wanna help me with some *hard* work?"
            }
        };

        // Chat setup
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        let selectedCharacter = null;
        let isNSFW = false;
        let conversationHistory = [];

        // Hugging Face API call with DialoGPT
        async function generateAIResponse(character, message) {
            const charData = characters[character];
            // Build a detailed prompt with strict instructions for roleplay
            let prompt = `You are ${charData.name}, a ${charData.persona}${isNSFW ? ", and you're feeling flirty and bold" : ""}. You are roleplaying in a fun, immersive conversation. Your goal is to:
- Respond directly to the user's message.
- Stay in character with a ${charData.tone} tone.
- Build on the user's input to continue the story together.
- Keep replies short, conversational, and engaging (1-2 sentences).
Here’s an example of how you’d respond:
${charData.example}

`;
            
            // Add conversation history (last 3 exchanges) for context
            const historyLength = Math.min(conversationHistory.length, 3);
            if (historyLength > 0) {
                prompt += "Recent conversation:\n";
                for (let i = conversationHistory.length - historyLength; i < conversationHistory.length; i++) {
                    const msg = conversationHistory[i];
                    prompt += `${msg.role === "user" ? "User" : charData.name}: ${msg.content}\n`;
                }
            }

            // Add the current message with clear instruction
            prompt += `Now, respond to the user's message below as ${charData.name}, staying in character and building on their input:\nUser: ${message}\n${charData.name}:`;

            const API_TOKEN = "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";

            try {
                const response = await fetch("https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_TOKEN}`
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: { max_length: 50, temperature: 0.8, top_p: 0.9, return_full_text: false }
                    })
                });

                const data = await response.json();
                if (data && data[0] && data[0].generated_text) {
                    let reply = data[0].generated_text.trim();
                    // Check if the reply engages with the user
                    const userWords = message.toLowerCase().split(/\s+/);
                    const replyWords = reply.toLowerCase().split(/\s+/);
                    const isEngaging = userWords.some(word => replyWords.includes(word)) || reply.includes("?") || reply.includes("you");
                    if (!isEngaging) {
                        throw new Error("Response doesn’t engage with user");
                    }
                    return reply.split("\n")[0];
                } else {
                    throw new Error("No response from API");
                }
            } catch (error) {
                console.error("API Error:", error);
                // Fallback to a rule-based response to ensure engagement
                const starters = {
                    sassy: ["Tch", "Yo", "Hmph"],
                    playful: ["Hehe", "Oh", "Well"],
                    bold: ["Hey", "Hmph", "What"],
                    confident: ["Alright", "Yo", "Nice"],
                    teasing: ["Well", "Heh", "Oh"],
                    haughty: ["Behold", "Hmph", "Fool"],
                    mysterious: ["Hmm", "Oh", "Well"],
                    flirty: ["Howdy", "Sweet", "Well"]
                };
                const starter = starters[charData.tone][Math.floor(Math.random() * 3)];
                const userLastWord = message.split(" ").pop().toLowerCase();
                return `${starter}, you’re talking about ${userLastWord}, huh? Let’s see where that takes us!`;
            }
        }

        // Chatbot logic
        function selectCharacter(character) {
            selectedCharacter = character;
            conversationHistory = [];
            const intro = `Hey, I’m ${characters[character].name}. Let’s have some fun—what’s on your mind?`;
            chatDisplay.innerHTML = `<div class="chat-message bot-message">${characters[character].name}: ${intro}</div>`;
            conversationHistory.push({ role: "bot", content: intro });
        }

        function toggleNSFW() {
            isNSFW = !isNSFW;
            document.getElementById('nsfw-toggle').innerText = `NSFW (${isNSFW ? 'On' : 'Off'})`;
            if (selectedCharacter) {
                chatDisplay.innerHTML += `<div class="chat-message">NSFW mode ${isNSFW ? 'on' : 'off'}.</div>`;
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) {
                alert("Type something!");
                return;
            }
            if (!selectedCharacter) {
                alert("Pick a character first!");
                return;
            }

            chatDisplay.innerHTML += `<div class="chat-message user-message">You: ${message}</div>`;
            conversationHistory.push({ role: "user", content: message });

            const response = await generateAIResponse(selectedCharacter, message);
            chatDisplay.innerHTML += `<div class="chat-message bot-message">${characters[selectedCharacter].name}: ${response}</div>`;
            conversationHistory.push({ role: "bot", content: response });
            chatDisplay.scrollTop = chatDisplay.scrollHeight;

            userInput.value = '';
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
